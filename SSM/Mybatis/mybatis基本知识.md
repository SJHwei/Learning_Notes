## MyBatis架构体系

​		对于任何一个持久层框架(mybatis框架), 主要分为三层: **接口应用层**, **数据处理层**, **基础服务层**.

#### 1. 接口应用层

* 该层主要负责对外提供应用服务, 例如:
  1. 数据查询接口;
  2. 数据修改接口;
  3. 数据删除接口;
  4. 数据插入接口.
* 接口的调用方式有两种: 
  1. 基于Statement ID;
  2. 基于Mapper接口.

#### 2. 数据处理层

* 主要负责处理数据访问问题:
  1. **SQL参数映射**: Dao方法参数与映射文件中#{}表达式映射;
  2. **SQL解析**(语法, 语义): 例如: select * from blog where id=#{id};
  3. **SQL执行**: 将sql发送到数据库端执行;
  4. **SQL结果映射**: 例如将ResultSet中的数据存到map.

#### 3. 基础服务层

* 主要负责提供如下几个方面的服务:
  1. 连接服务: 配置连接池;
  2. 事务服务: 保证数据的原子性, 一致性, 隔离性, 持久性;
  3. 缓存服务: 更好的提高查询性能;
  4. 配置服务: 别名配置, 映射配置, 日志配置, ...

* 基础服务层包括两层: 框架支撑层和引导层.
* **框架支撑层** : 
  1. SQL语句配置方式(两种): 基于xml配置; 基于注解. 对应于上面的配置服务.
  2. 事务管理: 对应上面的事务服务.
  3. 连接池管理: 对应于上面的连接服务.
  4. 缓存机制: 对应上面的缓存服务.
* **引导层** : 基于xml配置方式; 基于java API方式.

## Mybatis框架设计模式

#### 1. 构造者模式

1. **作用** : 根据配置文件或者参数, 定制一个对象出来.
2. **好处** : 可以把定制对象的复杂过程隐藏起来, 只要调用一个方法, 把配置文件/参数传递进去, 就可以得到根据参数定制的对象.
3. **mybatis中的应用** : 使用`SqlSessionFactoryBuilder类`, 根据核心配置文件, 构造一个SqlSessionFactory对象.

#### 2. 工厂模式

1. **作用** : 用于代替new操作的一种模式, 是一种最常用的实例化对象的模式了.
2. **好处** : 可以降低程序之间的耦合性, 提高应用的可扩展性, 在功能维护时尽量少的代码修改.
3. **mybatis中的应用** : 使用`SQLSessionFactory`, 产生一个SQLSession对象出来.
4. **工厂模式和构造者模式的区别** : 
   1. 构造者模式: 根据参数/配置文件, 定制一个对象出来, 重点在于定制对象;
   2. 工厂模式: 批量生产同一类对象, 代替new操作, 用于解耦合, 重点在于解耦合.

#### 3. 代理模式

1. **作用** : 在某些情况下, 一个对象不适合或者不能直接调用另外一个对象, 就可以使用代理对象作为中介来间接调用.
2. **好处** : 职责清晰; 高扩展性.
3. **mybatis中的应用** : 没有被代理的目标对象(映射器(Dao)接口没有实现对象), 所有的工作由代理对象来完成. 这样我们只要提供接口即可, 不需要再编写实现类代码了.



## mybatis层次结构

#### 1. mybatis的层次结构图

![](D:\ssm框架-figure\12.png)

#### 2. mybatis的主要构件及其相互关系

1. **SqlSession** : 作为mybatis工作的主要顶层API, 表示和数据库交互的会话, 完成必要的数据库增删改查功能.
2. **Executor** : mybatis执行器, 是mybatis调度的核心, 负责SQL语句的生成和查询缓存的维护
3. **StatementHandler** : 封装了JDBC Statement操作, 负责处理IDBC的Statement的交互, 包括对Statement设置参数, 以及将JDBC返回的ResultSet结果集转换成List.
4. **ParameterHandler** : 负责根据传递的参数值, 对Statement对象设置参数.
5. **ResultSetHandler** : 负责将JDBC返回的ResultSet结果集对象转换成List类型的集合.
6. **TypeHandler** : 负责java数据类型和JDBC数据类型之间的映射和转换.
7. **MappedStatement** : MappedStatement维护了一条<select | update | delete | insert>节点的封装.
8. **SqlSource** : 负责根据用户传递的parameterObject, 动态地生成SQL语句, 将信息封装到BoundSql对象中, 并返回.
9. **BoundSql** : 表示动态生成的SQL语句以及相应的参数信息.
10. **Configuration** : mybatis所有的配置信息都维持在Configuration对象之中.



## mybatis配置

#### 1. Mybatis用maven工程需要导入依赖

* mybatis需要的jar包.

#### 2. 创建Dao接口(映射器)

* 在mybatis中, 把dao层的接口称之为映射器(取"调用接口的方法即相当于操作数据库"之意). 
* 映射器的类名, 可以叫"XXXMapper", 也可以叫"XXXDao".
* 注意: 只要创建接口即可, 不需要创建接口的实现类.

#### 3. 映射配置文件 xml

* namespace: 给哪个接口配置的映射, 写接口的全限定类名
* select标签: 表示要执行查询语句; 
* id: 给接口里哪个方法配置的, 写方法名;
* resultType: 结果集封装类型.
* 编写sql.

#### 4. mybatis日志配置

* 日志文件名: log4j.properties.

#### 5. mybatis核心配置文件xml

1. 核心配置文件的名称随意, 一般为SqlMapConfig.xml
2. 核心配置文件的位置随意, 一般为resources目录下. 核心配置文件主要包含两部分: 一部分是配置数据库连接信息; 另一部分是配置映射文件的位置.

#### 6. 编写测试